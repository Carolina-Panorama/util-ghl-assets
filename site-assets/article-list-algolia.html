<!-- Algolia-Powered Article List Widget -->
<!-- Displays a configurable list of articles with category/tag filtering -->

<style>
    .article-list-wrapper {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: clamp(16px, 2vw, 24px);
    }

    .article-list-container {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .article-list-item {
        border-bottom: 1px solid #e5e7eb;
    }

    .article-list-item:last-child {
        border-bottom: none;
    }

    .article-list-item .cp-article-card {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: clamp(20px, 2.5vw, 32px);
        align-items: center;
        padding: clamp(16px, 2vw, 24px) clamp(8px, 1vw, 10px);
    }

    .article-list-item .cp-article-card-link {
        display: contents;
    }

    .article-list-item .cp-article-content {
        order: 1;
        padding: 0;
    }

    .article-list-item .cp-article-image {
        order: 2;
        height: 180px;
        width: 100%;
        border-radius: 6px;
    }

    /* Loading state */
    .article-list-loading {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-size: 1.1rem;
    }

    .article-list-loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }

    /* Error state */
    .article-list-error {
        text-align: center;
        padding: 40px 20px;
        color: #dc2626;
        background: #fee;
        border-radius: 6px;
        margin: 20px 0;
    }

    /* Empty state */
    .article-list-empty {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-size: 1.1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .article-list-item .cp-article-card {
            grid-template-columns: 1fr;
            gap: clamp(12px, 2vw, 16px);
        }

        .article-list-item .cp-article-content {
            order: 2;
        }

        .article-list-item .cp-article-image {
            order: 1;
            height: 200px;
        }
    }
</style>

<div class="article-list-wrapper">
    <div id="algolia-article-list" class="article-list-container">
        <div class="article-list-loading">Loading articles</div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // Load Algolia library if not already loaded
    function loadAlgolia() {
        return new Promise((resolve, reject) => {
            if (typeof algoliasearch !== 'undefined') {
                resolve(algoliasearch);
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js';
            script.onload = () => resolve(window.algoliasearch);
            script.onerror = () => reject(new Error('Failed to load Algolia'));
            document.head.appendChild(script);
        });
    }

    // Main initialization
    async function init() {
        const config = window.ALGOLIA_ARTICLE_LIST_CONFIG || {
            maxArticles: 10,
            category: null,
            tag: null,
            sortBy: 'publishedAt:desc'
        };

        const ALGOLIA_APP_ID = 'L5HJO2NLX1';
        const ALGOLIA_SEARCH_KEY = '303488aa839f0fc1c6c0467ae84a0354';
        const ALGOLIA_INDEX = 'prod_CarolinaPanorama';

        try {
            const algoliasearch = await loadAlgolia();
            const searchClient = algoliasearch(ALGOLIA_APP_ID, ALGOLIA_SEARCH_KEY);
            const index = searchClient.initIndex(ALGOLIA_INDEX);

        // Parse URL for category or tag
        function parseUrlFilters() {
            const urlPath = window.location.pathname;
            
            // Check for category: /category/business or /article-feed/category/business
            const categoryMatch = urlPath.match(/\/category\/([^\/]+)/);
            if (categoryMatch) {
                return { type: 'category', value: decodeURIComponent(categoryMatch[1]) };
            }
            
            // Check for tag: /tag/education
            const tagMatch = urlPath.match(/\/tag\/([^\/]+)/);
            if (tagMatch) {
                const tagSlug = decodeURIComponent(tagMatch[1]);
                // Convert slug to readable format (dash to space, capitalize)
                const tagName = tagSlug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return { type: 'tag', value: tagName };
            }
            
            return null;
        }

        // Build Algolia filters
        function buildFilters() {
            const urlFilter = parseUrlFilters();
            const filters = [];
            
            // URL-based filters take precedence
            if (urlFilter) {
                if (urlFilter.type === 'category') {
                    filters.push(`categories:"${urlFilter.value}"`);
                } else if (urlFilter.type === 'tag') {
                    filters.push(`tags:"${urlFilter.value}"`);
                }
            } 
            // Fallback to config
            else {
                if (config.category) {
                    filters.push(`categories:"${config.category}"`);
                }
                if (config.tag) {
                    filters.push(`tags:"${config.tag}"`);
                }
            }
            
            return filters.join(' AND ');
        }

        // Format date
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Create article card HTML
        function createArticleCard(article) {
            const categories = article.categories || [];
            const categoryTags = categories.slice(0, 2)
                .map(cat => `<span class="cp-article-tag ${cat.toLowerCase().replace(/\s+/g, '-')}">${cat}</span>`)
                .join(' ');

            const description = article.description || article.excerpt || '';
            const truncatedDesc = description.length > 200 
                ? description.substring(0, 200) + '...' 
                : description;

            return `
                <div class="article-list-item">
                    <article class="cp-article-card">
                        <a href="/post/${article.objectID}" class="cp-article-card-link">
                            <div class="cp-article-content">
                                ${categoryTags ? `<div class="cp-article-tags">${categoryTags}</div>` : ''}
                                <h3 class="cp-article-title">${article.title || 'Untitled'}</h3>
                                <div class="cp-article-meta">
                                    ${article.author ? `<span class="cp-article-author">${article.author}</span>` : ''}
                                    <span class="cp-article-date">${formatDate(article.publishedAt)}</span>
                                </div>
                                ${truncatedDesc ? `<p class="cp-article-description">${truncatedDesc}</p>` : ''}
                            </div>
                            <img src="${article.image || 'https://via.placeholder.com/280x180'}" 
                                 alt="${article.title || 'Article'}" 
                                 class="cp-article-image"
                                 loading="lazy">
                        </a>
                    </article>
                </div>
            `;
        }

        // Fetch and display articles
        const container = document.getElementById('algolia-article-list');
        
        try {
            const filters = buildFilters();
            
            const searchParams = {
                hitsPerPage: config.maxArticles,
                page: 0
            };
            
            if (filters) {
                searchParams.filters = filters;
            }

            const { hits } = await index.search('', searchParams);

            if (hits.length === 0) {
                container.innerHTML = '<div class="article-list-empty">No articles found.</div>';
                return;
            }

            const articlesHtml = hits.map(article => createArticleCard(article)).join('');
            container.innerHTML = articlesHtml;

        } catch (error) {
            console.error('Error loading articles:', error);
            container.innerHTML = `
                <div class="article-list-error">
                    Failed to load articles. Please try again later.
                </div>
            `;
        }
    } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('algolia-article-list').innerHTML = 
            '<div class="article-list-error">Failed to initialize widget.</div>';
    }
    }

    // Load articles when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
